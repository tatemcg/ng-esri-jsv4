<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Heat Map</title>
<style>
	 #viewDiv {
		padding: 0;
		margin: 0;
		height: 90%;
		width: 100%;
	  }
</style>
	<link rel="stylesheet" href="https://js.arcgis.com/4.13/esri/css/main.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://js.arcgis.com/4.13/"></script>
    <script>
	require([
      "esri/Map",
      "esri/views/MapView",
      "esri/Graphic",
      "esri/layers/GraphicsLayer",
	  "esri/widgets/Home",
	  "esri/geometry/Point"
    ], function(Map, MapView, Graphic, GraphicsLayer, Home, Point) {
		
		var map = new Map({
			basemap: "gray-vector"
		});
		
		var view = new MapView({
			container: "viewDiv",  
			map: map,
			center: [-66.519, 18.230],
			zoom: 8
		});
		
		var graphicsLayer = new GraphicsLayer();
		map.add(graphicsLayer);  
		var LocaData = [{"lat": "18.230","long":"-66.511"},
						{"lat": "18.130","long":"-66.539"},
						{"lat": "18.330","long":"-66.513"},
						{"lat": "18.250","long":"-66.529"},
						{"lat": "18.130","long":"-66.531"},
						{"lat": "18.335","long":"-66.513"},
						{"lat": "18.250","long":"-66.539"},
						{"lat": "18.130","long":"-66.549"},
						{"lat": "18.380","long":"-66.513"},
						{"lat": "18.250","long":"-66.524"},
						{"lat": "18.280","long":"-66.517"}]; 
		
		//Home button
		let homeBTN = new Home({
          view:view
        })
		view.ui.add(homeBTN, "top-right"); //add home button to map view ui
		document.getElementById("getJsonData").addEventListener("click", getJsonData)
		/*function getJsonData2(){
			getJsonData(); 
		}*/
		function getJsonData(){
			$.ajax({
				//url: "https://data.police.uk/api/crimes-street/all-crime?",
				//url: "https://spgwinbox.northeurope.cloudapp.azure.com/tpbackend_demo/api/mapview/padamagepoint?disaster=3&category=12",
				//url: "https://spgwinbox.northeurope.cloudapp.azure.com/tpbackend_demo/api/mapview/padamagepoint?disaster=3&category=1&category=12",
				url: "https://spgwinbox.northeurope.cloudapp.azure.com/tpbackend_demo/api/mapview/padamagepoint",
				type: "GET",
				data: {
					//'f': 'pjson',
					//'poly': currentExtent,
					//'date': date
				}
			}).done(function (data) {
				/*for(let i = 0; i< data.length; i++)
				{
					console.log(i +" " +data[i].applicant_id); 
				}*/
				for(var i = 0; i< data.length; i++) //2500
				{
					var point = {
						type: "point",
						longitude: data[i].longitude,
						latitude: data[i].latitude

					};
					var simpleMarkerSymbol = {
						type: "simple-marker",
						style: "circle",
						size: 9,
						color: [226, 119, 240], 
						outline: {
							color: [255, 255, 255],
							width: 1
						}
					};
					let attrs = {
						"id": data[i].applicant_id,
						"obligated": data[i].obligated_amt,
						"disbursed": data[i].disbursed_amt
					}
					/*attributes: {
						Category: data[i].applicant_id,
						obligated: data[i].obligated_amt,
						disbursed: data[i].disbursed_amt
					},
					popupTemplate: { // autocasts as new PopupTemplate()
						title: "App ID:{Category}",
						content: [{
							type: "fields",
							fieldInfos: [{
								fieldName: "obligated"
							}, {
								fieldName: "disbursed"
							}]
						}]
					}*/
					var pointGraphic = new Graphic({
						geometry: point,
						attributes: attrs,
						symbol: simpleMarkerSymbol,
						popupTemplate: { // autocasts as new PopupTemplate()
							title: "Applicant ID:{id}",
							content: [{
								type: "fields",
								fieldInfos: [{
									fieldName: "obligated"
								}, {
									fieldName: "disbursed"
								}]
							}]
						}
					});
					graphicsLayer.add(pointGraphic);
				}
				//Use all returning data to add points to a map.
				//createPointsOnMap(data)

			});
		}
		
		/*view.when().then(function()
		{
			for(var i = 0; i< LocaData.length; i++)
			{
				var point = {
					type: "point",
					longitude: LocaData[i].long,
					latitude: LocaData[i].lat

				};
				var simpleMarkerSymbol = {
					type: "simple-marker",
					style: "circle",
					color: [226, 119, 240], 
					outline: {
						color: [255, 255, 255],
						width: 1.5
					}
				};
				var pointGraphic = new Graphic({
					geometry: point,
					symbol: simpleMarkerSymbol
				});
				graphicsLayer.add(pointGraphic);
			}
			const layer = view.map.layers.getItemAt(0);
			const heatmapRenderer = layer.renderer.clone();
			view.watch("scale", function(newValue) 
			{
				layer.renderer =
				newValue <= 72224 ? simpleMarkerSymbol : heatmapRenderer;
			});
		})*/

	});
	</script>

</head>
<body>
	<div id="getJsonData"><button class="button" id="getJsonData">Damage Points</button></div>
	<div id="viewDiv"></div>
</body>
</html> 